<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game 2D — simples</title>
    <style>
        /* Tela cheia */
        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: #111;
        }

        #stage {
            width: 100vw;
            height: 100vh;
            background: #222;
            position: relative;
            overflow: hidden;
        }

        /* Sprite básico (32x32) */
        .sprite {
            width: 32px;
            height: 32px;
            position: absolute;
            bottom: 0;
            left: 0;
            image-rendering: pixelated;
            /* nítido */
            background-repeat: no-repeat;
            transform-origin: bottom left;
        }

        /* Idle: 11 frames => 11*32 = 352px */
        .idle-humano {
            background-image: url('assets/Idle.png');
            animation: idle 1.1s steps(11) infinite;
        }

        .idle-yellow {
            background-image: url('assets/IdleYellow.png');
            animation: idle 1.1s steps(11) infinite;
        }

        @keyframes idle {
            from {
                background-position: 0 0;
            }

            to {
                background-position: -352px 0;
            }
        }

        /* Run: 12 frames => 12*32 = 384px */
        .run-humano {
            background-image: url('assets/Run.png');
            animation: run 0.8s steps(12) infinite;
        }

        .run-yellow {
            background-image: url('assets/RunYellow.png');
            animation: run 0.8s steps(12) infinite;
        }

        @keyframes run {
            from {
                background-position: 0 0;
            }

            to {
                background-position: -384px 0;
            }
        }

        #box {
            width: 64px;
            height: 64px;
            position: absolute;
            bottom: -10px;
            right: 1000px;
            background-image: url('assets/box.png');
            image-rendering: pixelated;
            background-repeat: no-repeat;
            background-size: cover;
        }
    </style>
</head>

<body>
    <div id="stage">
        <div id="hero" class="sprite" aria-label="heroi"></div>
        <div id="box"></div>
    </div>

    <script>
        const buscarHeroi = localStorage.getItem("hero")
        let idle = ""
        let run = ""

        if (buscarHeroi === "humano") {
            const hero = document.getElementById('hero');
            hero.classList.add("idle-humano")
            idle = "idle-humano"
            run = "run-humano"
        } else if (buscarHeroi === "yellow") {
            const hero = document.getElementById('hero');
            hero.classList.add("idle-yellow")
            idle = "idle-yellow"
            run = "run-yellow"
        }

        // Estado Horizontal do personagem
        const hero = document.getElementById('hero');
        const box = document.getElementById('box');
        let x = 50;           // posição horizontal
        let velocidade = 0;   // 0 parado; >0 andando
        const SCALE = 2;

        // Estado vertical do personagem
        let y = 0;             // posição vertical (0 = chão)
        let velocidadeY = 0;   // velocidade vertical
        const gravidade = 0.5; // força que puxa para baixo
        const puloForca = -8;  // força do pulo
        let pulando = false;

        // Box position (left edge)
        const boxRight = 1000;            // deslocamento da direita em px (CSS: right: 1000px)
        const boxWidth = 32 * SCALE;      // 64px (coerente com CSS)
        const stageWidth = window.innerWidth;
        const boxLeft = stageWidth - boxRight - boxWidth;

        // Auxiliares verticais da box (para topo)
        const boxHeight = parseInt(getComputedStyle(box).height, 10);           // 64
        const boxBottomOffset = parseInt(getComputedStyle(box).bottom, 10) || 0; // -10
        // Altura do topo da box acima da linha do chão (chão = 0). Ex.: 64 + (-10) = 54
        const boxTopHeight = boxHeight + boxBottomOffset;

        // Loop simples só para mover (animação é CSS)
        function atualizar() {
            // Projeções
            let nextX = x + velocidade;
            let nextY = y;

            const heroWidth = 32 * SCALE;
            const heroHeight = 32 * SCALE;
            const boxRightEdge = boxLeft + boxWidth;

            // ----- GRAVIDADE / PULO (sempre que pulando) -----
            if (pulando) {
                nextY += velocidadeY;     // move vertical
                velocidadeY += gravidade; // acelera para baixo
            }

            // ----- ATERRISSAGEM NO TOPO DA BOX -----
            // Checa se há sobreposição horizontal com a box
            const overlapHorizontal = (nextX + heroWidth) > boxLeft && nextX < boxRightEdge;

            // "Altura" do pé do herói acima do chão (chão = 0). Como y sobe negativo, usamos -y.
            const heroBottomAltAntes = -y;
            const heroBottomAltDepois = -nextY;

            // Condição de cruzamento do topo: vinha de cima e está descendo, cruzando a cota do topo
            if (
                overlapHorizontal &&
                velocidadeY > 0 &&              // está caindo
                heroBottomAltAntes > boxTopHeight &&
                heroBottomAltDepois <= boxTopHeight
            ) {
                // Cola no topo da caixa
                nextY = -boxTopHeight;
                pulando = false;
                velocidadeY = 0;
            }

            // ----- COLISÃO LATERAL (APENAS SE NÃO ESTIVER ACIMA DO TOPO) -----
            if (
                overlapHorizontal &&
                heroBottomAltDepois < boxTopHeight - 0.01 && // bloqueia só quando está ABAIXO do topo
                velocidade > 0
            ) {
                nextX = boxLeft - heroWidth;
            }

            // ----- CHÃO -----
            if (nextY > 0) { // passou do chão
                nextY = 0;
                pulando = false;
                velocidadeY = 0;
            }

            // ----- DESPENCAR DA BORDA DA BOX -----
            // Se não está pulando, mas está acima do chão e NÃO há apoio (fora da projeção da box),
            // ativa a queda.
            const sobreTopoDaBox = overlapHorizontal && Math.abs((-nextY) - boxTopHeight) < 0.5;
            if (!pulando && nextY < 0 && !sobreTopoDaBox) {
                pulando = true; // começa a cair
                // garante uma queda suave caso estivesse "preso"
                if (velocidadeY <= 0) velocidadeY = 0.1;
            }

            // Atualiza posição e desenha
            x = nextX;
            y = nextY;
            hero.style.transform = `translate(${x}px, ${y}px) scale(${SCALE})`;

            requestAnimationFrame(atualizar);
        }
        requestAnimationFrame(atualizar);

        // Teclas: seta para a direita liga/desliga correr
        document.addEventListener('keydown', (e) => {
            if (e.code === 'ArrowRight') {
                e.preventDefault();
                hero.classList.remove(idle);
                hero.classList.add(run);
                velocidade = 2;
            }
        });

        // Espaço para pular e Seta up
        document.addEventListener('keydown', (e) => {
            if ((e.code === 'ArrowUp' || e.code === 'Space') && !pulando) {
                e.preventDefault();
                pulando = true;
                velocidadeY = puloForca;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowRight') {
                hero.classList.remove(run);
                hero.classList.add(idle);
                velocidade = 0;
            }
        });
    </script>
</body>

</html>